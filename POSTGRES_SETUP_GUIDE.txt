#!/usr/bin/env python
"""
Switch to PostgreSQL - Simple Setup Guide
"""
import os
import sys

print("""
╔══════════════════════════════════════════════════════════════════════════════╗
║                   SWITCH TO POSTGRESQL - SETUP GUIDE                         ║
╚══════════════════════════════════════════════════════════════════════════════╝

To solve the database data loss issue, we're switching from SQLite to PostgreSQL.

STEP 1: Install PostgreSQL
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Windows:
  1. Download from: https://www.postgresql.org/download/windows/
  2. Run the installer
  3. Remember the password you set for the 'postgres' user
  4. Accept default port: 5432

macOS (with Homebrew):
  brew install postgresql
  brew services start postgresql

Linux (Ubuntu/Debian):
  sudo apt-get update
  sudo apt-get install postgresql postgresql-contrib

STEP 2: Verify Installation
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Open a terminal and run:
  psql --version

You should see something like: "psql (PostgreSQL) X.X.X"

STEP 3: Create Database and User
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Open PostgreSQL command prompt:
Windows: Start > PostgreSQL > SQL Shell (psql)
macOS/Linux: psql postgres

Then run these commands (replace 'mypassword' with a secure password):

  CREATE USER godly_user WITH PASSWORD 'mypassword';
  ALTER ROLE godly_user SET client_encoding TO 'utf8';
  ALTER ROLE godly_user SET default_transaction_isolation TO 'read committed';
  ALTER ROLE godly_user SET default_transaction_deferrable TO on;
  ALTER ROLE godly_user SET timezone TO 'UTC';
  CREATE DATABASE godlywomen_db OWNER godly_user ENCODING 'UTF-8';
  GRANT ALL PRIVILEGES ON DATABASE godlywomen_db TO godly_user;
  
Type '\\q' to exit psql

STEP 4: Configure Environment
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Create or update 'backend/.env' (or 'backend/.env.local') with:

  # PostgreSQL
  DB_HOST=localhost
  DB_PORT=5432
  DB_NAME=godlywomen_db
  DB_USER=godly_user
  DB_PASSWORD=mypassword  # Use your secure password here
  
  # Django
  DJANGO_SECRET_KEY=your-secret-key-here
  DEBUG=True

STEP 5: Run Migrations
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

cd backend
python manage.py migrate

You should see output like:
  Running migrations:
    Applying contenttypes.0001_initial... OK
    ...
    Applying articles.0008_create_default_categories... OK

STEP 6: Test the Backend
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

cd backend
python manage.py test_backend_health.py

Or run the server:
  python manage.py runserver

STEP 7: Production Deployment (Render)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

In Render dashboard:
  1. Create a new PostgreSQL database
  2. Get the DATABASE_URL from the connection string
  3. Add to your service environment variables:
     DATABASE_URL=postgresql://user:password@host:port/dbname
  
  That's it! The app will automatically use PostgreSQL when DATABASE_URL is set.

BENEFITS OF POSTGRESQL
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✓ ACID Compliance - Ensures data consistency and prevents loss
✓ Better Concurrency - Handles multiple users without corruption
✓ Persistent Storage - Data survives container restarts
✓ Scalability - Can handle production traffic
✓ Full-Text Search - Built-in search capabilities
✓ JSON Support - Native JSON data types
✓ Open Source - Free and widely supported

TROUBLESHOOTING
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

If you get "could not connect to server" error:
  • Ensure PostgreSQL service is running
  • Check the host, port, and credentials
  • Firewall may be blocking the connection

If you get "database does not exist":
  • Run the CREATE DATABASE command above
  • Check the database name matches in .env

If migrations fail:
  • Make sure PostgreSQL is running
  • Verify the user has permissions on the database
  • Check the connection string is correct

╔══════════════════════════════════════════════════════════════════════════════╗
║                   Questions? Check the docs in the repo!                     ║
╚══════════════════════════════════════════════════════════════════════════════╝
""")
